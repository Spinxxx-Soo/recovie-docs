# 운영 및 개발 정책 (Policy)

본 문서는 **영화 시나리오 분석 플랫폼(Recovie)**의  
외부 API 적재 정책과 Git/GitHub 협업 규칙, 그리고 개발팀 공통 운영 원칙을 정의합니다.

본 정책은 다음 목표를 가집니다.

- 외부 데이터 적재의 안정성과 일관성 확보
- 협업 시 코드/이슈/브랜치 관리의 혼선 방지
- 설계 → 구현 → 배포 흐름의 표준화
- 개인 프로젝트이지만 **팀 프로젝트로 확장 가능한 구조 유지**

---

## 1. 외부 영화 API 적재 정책

### 1.1 데이터 소스
- 기본 소스: **TMDB**
- (확장 가능) OMDb 등 보조 소스

외부 API는 **읽기 전용 데이터 소스**로 사용하며,  
플랫폼 내부 데이터(분석, 태그, 통계)는 외부로 동기화하지 않는다.

---

### 1.2 중복 기준 (Unique Key)

- `movies.external_movie_id` 를 **유일 키(UNIQUE)** 로 사용
- 형식:

{source}:{externalId}

```
예)
- `tmdb:550`
- `omdb:tt0137523`

이 규칙을 통해:
- 다중 API 사용 시 충돌 방지
- 소스별 재적재/정책 분리 가능

---

### 1.3 최초 적재(Initial Load)

목표:
- MVP 단계에서 검색/탐색 가능한 영화 풀 확보

적재 기준(예시):
- 인기 영화 / 트렌딩
- 최근 개봉작
- 장르별 상위 N 페이지

정책:
- 관리자 또는 스케줄러에 의해 **비동기 워커로 실행**
- API 서버는 `202 Accepted` 로 즉시 응답

---

### 1.4 재적재(Update / Sync)

재적재 대상:
- popularity, vote_average, vote_count
- poster_url, backdrop_url
- overview, runtime (상대적으로 낮은 빈도)

재적재 기준:
- `last_synced_at` 기준 **N일 경과**
- 일반 영화: 7일
- 최근 개봉/인기 급상승 영화: 1일

플랫폼 내부에서 **분석 수가 많은 영화**는 재적재 우선순위를 높인다.

---

### 1.5 UPSERT 전략

외부 데이터 적재 시 반드시 **UPSERT** 사용

- PostgreSQL:
```sql
INSERT ... 
ON CONFLICT (external_movie_id)
DO UPDATE SET ...
```

정책:

* 동일 영화 재적재 시 **중복 row 생성 금지**
* 변경된 필드만 업데이트
* 장르 매핑(movie_genres)은 복합 PK로 중복 자동 방지

---

### 1.6 장애 / 레이트리밋 대응

* 외부 API 호출은 워커에서 수행
* 재시도 정책:

  * 429 / 5xx 에러 → 최대 3~5회 재시도
  * 지수 백오프(1s → 2s → 4s ...)
* 반복 실패 시:

  * 실패 로그 기록
  * 서비스 기능은 DB + 캐시 데이터로 정상 동작 유지

---

## 2. Git 커밋 컨벤션 (Conventional Commits)

본 프로젝트는 **Conventional Commits** 규칙을 따른다.

### 2.1 기본 형식

```
<type>: <summary>
```

### 2.2 타입 정의(보편적 규칙)

| Type     | 의미                    |
| -------- | --------------------- |
| feat     | 새로운 기능                |
| fix      | 버그 수정                 |
| docs     | 문서 추가/수정              |
| style    | 포맷/세미콜론/공백 (로직 변경 없음) |
| refactor | 리팩토링                  |
| test     | 테스트 코드                |
| chore    | 빌드/설정/기타 작업           |

### 2.3 커밋 메시지 예시

```
feat: 영화 분석 작성 API 추가
fix: 영화 목록 페이징 오류 수정
docs: API 명세 문서 추가
refactor: 영화 도메인 서비스 책임 분리
chore: Docker Compose 설정 정리
```

> 커밋 메시지는 **한글 작성**을 기본으로 한다.

---

## 3. 브랜치 전략

### 3.1 기본 브랜치

* `main` : 항상 배포 가능한 상태
* `develop` (선택): 통합 개발 브랜치

### 3.2 작업 브랜치 규칙

```
type/short-description
```

예시:

```
feat/movie-api
feat/analysis-create
fix/movie-sync-bug
docs/architecture-update
```

### 3.3 브랜치 정책

* 하나의 브랜치 = 하나의 작업 목적
* 브랜치는 짧게 유지
* 머지 후 삭제 원칙

---

## 4. 이슈 관리 규칙

### 4.1 이슈 생성 기준

아래 작업은 반드시 이슈로 관리한다.

* 기능 추가
* 버그 수정
* 설계 변경
* API / DB 스키마 변경
* 문서 작업(설계 문서 포함)

---

### 4.2 이슈 제목 규칙

```
[type] 간단한 작업 요약
```

예시:

```
[feat] 영화 분석 작성 기능 구현
[fix] 영화 재적재 중복 문제 수정
[docs] DB 스키마 문서화
```

---

### 4.3 이슈 본문 권장 템플릿

```md
## 개요
무엇을, 왜 하는 작업인지 간단 설명

## 작업 내용
- [ ] 세부 작업 1
- [ ] 세부 작업 2

## 참고
- 관련 API / 문서 / 링크
```

---

### 4.4 커밋/PR과 이슈 연결

* 커밋 메시지 또는 PR 본문에 이슈 번호 명시

```
feat: 영화 분석 저장 API 구현 (#12)
```

---

## 5. Pull Request 규칙 (선택)

### 5.1 PR 생성 기준

* 하나의 PR = 하나의 이슈
* 기능/수정 단위가 명확해야 함

### 5.2 PR 제목 규칙

```
[type] 작업 요약 (#이슈번호)
```

예시:

```
[feat] 영화 목록 조회 API 구현 (#3)
```

---

## 6. 코드 및 설계 공통 원칙

### 6.1 설계 원칙

* Controller: 요청/응답, 인증 처리
* Service: 비즈니스 로직
* Repository: 데이터 접근
* 외부 API 연동은 Client 계층에서만 수행

---

### 6.2 확장성 원칙

* 통계/추천/적재는 **비동기 처리 우선**
* 캐시/워커/추천 서비스는 독립 가능하도록 설계
* 초기엔 단순 구현, 교체 가능성 열어두기

---

## 7. 문서화 원칙

* 모든 주요 변경 사항은 문서에 반영
* 설계 변경 시:

  * architecture.md
  * api.md
  * db.md
  * policy.md
    중 **해당 문서 반드시 업데이트**

---

## 8. 체크 포인트

* [ ] 외부 API 적재 중복 방지 확인
* [ ] 커밋 컨벤션 준수
* [ ] 브랜치 목적 명확
* [ ] 이슈 기반 작업 여부
* [ ] 문서 최신화 여부

```